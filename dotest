#!/usr/bin/env python
import tempfile
import shutil
import subprocess
import os
import argparse
import schroot


env = {
        'PATH': '/usr/sbin:/usr/bin:/sbin:/bin',
        'DEBCONF_DEBUG': 'developer',
}


def call(chroot, cmd, user=None, **kwargs):
    print("")
    print("---> %s" % (cmd,))
    chroot.check_call(cmd, user=user, env=env, **kwargs)


def setup(chroot):
    call(chroot, ["apt-get", "update"], user='root')
    call(chroot, ["apt-get", "upgrade", "--yes"], user='root')
    # python-support required for pysupport, should be replaced by python2 install method.
    call(chroot, ["apt-get", "install", "--yes", "git", "build-essential", "debhelper", "cdbs", "python-support"], user='root')
    call(chroot, ["debconf-set-selections", "debconf.conf"], user='root')


def build_git_package(chroot, src, name, branch="master"):
    old_dir = os.getcwd()
    try:
        call(chroot, ["git", "clone", "--branch", branch, src, name])
        os.chdir(name)
        call(chroot, ["dpkg-checkbuilddeps"])
        call(chroot, ["fakeroot", "debian/rules", "binary"])
    finally:
        os.chdir(old_dir)


def add_sources(chroot, tmp_dir, distribution, source):
    if source == "local":
        old_dir = os.getcwd()
        try:
            os.chdir(tmp_dir)
            build_git_package(chroot, "file:///home/brian/tree/django/django-tldap/django-tldap", "django-tldap")
            build_git_package(chroot, "file:///home/brian/tree/django/django-placard/django-placard", "django-placard")
            build_git_package(chroot, "file:///home/brian/tree/django/karaage/karaage", "karaage", "triggers")
            build_git_package(chroot, "file:///home/brian/tree/django/karaage/karaage-common", "karaage-common")
            build_git_package(chroot, "file:///home/brian/tree/django/karaage/karaage-admin", "karaage-admin")
            build_git_package(chroot, "file:///home/brian/tree/django/karaage/karaage-registration", "karaage-registration")

            with open('Packages', 'w') as f:
                call(chroot, ["dpkg-scanpackages", "."], stdout=f)
        finally:
            os.chdir(old_dir)

        with chroot.create_file('/etc/apt/sources.list', user='root') as f:
            f.write("deb file://%s ./\n" % (tmp_dir))
            f.write("deb http://hq.in.vpac.org:9999/debian %s main\n" % distribution)
            f.write("deb http://code.vpac.org/debian/ %s main\n" % distribution)

        with chroot.create_file('/etc/apt/preferences', user='root') as f:
            f.write("Package: *\n")
            f.write("Pin: release l=VPAC\n")
            f.write("Pin-Priority: 500\n")
            f.write("\n")

        allow_unauthenticated = True
    elif source == "github":
        old_dir = os.getcwd()
        try:
            os.chdir(tmp_dir)
            build_git_package(chroot, "git://github.com/VPAC/django-tldap.git", "django-tldap")
            build_git_package(chroot, "git://github.com/VPAC/django-placard.git", "django-placard")
            build_git_package(chroot, "git://github.com/Karaage-Cluster/karaage.git", "karaage")
            build_git_package(chroot, "git://github.com/Karaage-Cluster/karaage-common.git", "karaage-common")
            build_git_package(chroot, "git://github.com/Karaage-Cluster/karaage-admin.git", "karaage-admin")
            build_git_package(chroot, "git://github.com/Karaage-Cluster/karaage-registration.git", "karaage-registration")

            with open('Packages', 'w') as f:
                call(chroot, ["dpkg-scanpackages", "."], stdout=f)
        finally:
            os.chdir(old_dir)

        with chroot.create_file('/etc/apt/sources.list', user='root') as f:
            f.write("deb file://%s ./\n" % (tmp_dir))
            f.write("deb http://hq.in.vpac.org:9999/debian %s main\n" % distribution)
            f.write("deb http://code.vpac.org/debian/ %s main\n" % distribution)

        with chroot.create_file('/etc/apt/preferences', user='root') as f:
            f.write("Package: *\n")
            f.write("Pin: release l=VPAC\n")
            f.write("Pin-Priority: 500\n")
            f.write("\n")

        allow_unauthenticated = True
    elif source == "vpac":

        with chroot.create_file('/etc/apt/sources.list', user='root') as f:
            f.write("deb http://hq.in.vpac.org:9999/debian %s main\n" % distribution)
            f.write("deb http://code.vpac.org/debian/ %s main\n" % distribution)

        with chroot.create_file('/etc/apt/preferences', user='root') as f:
            pass

        allow_unauthenticated = False
    else:

        raise RuntimeError("Oops. Unknown source.")

    call(chroot, ["apt-key", "add", "vpac/vpac-debian-key.gpg"], user='root')
    call(chroot, ["apt-get", "update"], user='root')

    return allow_unauthenticated


def install_mysql(chroot):
    call(chroot, ["apt-get", "install", "--yes", "mysql-server"], user='root')

    with open('mysql/setup.sql', 'r') as f:
        call(chroot, ["mysql", "--user=root", "--password=mysqlsecret"], stdin=f)


def install_slapd(chroot):
    call(chroot, ["apt-get", "install", "--yes", "slapd", "ldap-utils"], user='root')

    with open('slapd/ppolicy.ldif', 'r') as f:
        call(chroot, ["ldapadd", "-Y", "EXTERNAL", "-H", "ldapi:///"], stdin=f, user='root')

    with open('slapd/ppolicy2.ldif', 'r') as f:
        call(chroot, ["ldapadd", "-x", "-H", "ldapi:///", "-D", "cn=admin,dc=example,dc=org", "-w", "slapdsecret"], stdin=f)

    with open('slapd/ppolicy3.ldif', 'r') as f:
        call(chroot, ["ldapadd", "-Y", "EXTERNAL", "-H", "ldapi:///"], stdin=f, user='root')


def install_karaage(chroot, allow_unauthenticated):
    args = []
    if allow_unauthenticated:
        args += ["--allow-unauthenticated"]

    call(chroot, ["apt-get", "install", "--yes", "libjs-jquery-ui", "python-mysqldb"], user='root')
    call(chroot, ["apt-get", "install", "--yes", "karaage"] + args, user='root')
    call(chroot, ["apt-get", "install", "--yes", "karaage-admin", "karaage-registration"] + args, user='root')

def config_karaage(chroot, tmp_dir):
    chroot.copy("karaage/global_settings.py", "/etc/karaage/global_settings.py", user="root")

    call(chroot, ["kg_set_secret_key"], user='root')
    call(chroot, ["kg-manage", "init_ldap"], user='root')
    call(chroot, ["kg-manage", "syncdb", "--noinput"], user='root')
    call(chroot, ["kg-manage", "migrate", "--all"], user='root')


def remove_karaage(chroot):
    call(chroot, ["apt-get", "remove", "--purge", "--yes", "karaage-admin", "karaage-registration"], user='root')
    call(chroot, ["apt-get", "autoremove", "--purge", "--yes" ], user='root')


def test_karaage(chroot, tmp_dir, args):
    setup(chroot)
    allow_unauthenticated = add_sources(chroot, tmp_dir, args.distribution, args.source)
    install_mysql(chroot)
    install_slapd(chroot)
    install_karaage(chroot, allow_unauthenticated)
    config_karaage(chroot, tmp_dir)
    remove_karaage(chroot)


def main():
    parser = argparse.ArgumentParser(description='Test karaage Debian packages.')
    parser.add_argument("-d", "--distribution", choices=['squeeze', 'wheezy'], default="wheezy", help="Which distribution?")
    parser.add_argument("-s", "--source", choices=['local', 'github', 'vpac'], default="github", help="Where to get packages from")
    parser.add_argument("-r", "--shell", action="store_true", help="Run shell on error")
    args = parser.parse_args()

    tmp_dir = None
    try:
        tmp_dir = tempfile.mkdtemp()

        with schroot.schroot(args.distribution) as chroot:
            try:
                test_karaage(chroot, tmp_dir, args)
            except Exception, e:
                if args.shell:
                    print("")
                    print("Exception occured. tmp_dir=%s" % tmp_dir)
                    print(e)
                    print("Entering shell, please exit to finish.")
                    call(chroot, ["bash"], user='root')
                raise

    finally:
        try:
            if tmp_dir is not None:
                shutil.rmtree(tmp_dir) # delete directory
        except OSError, e:
            if e.errno != 2: # code 2 - no such file or directory
                raise

if __name__ == "__main__":
    main()
